<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Stratum 1 NTP Server From WWV/H or CHU :: KE8MUJ Radio Stuff</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="The first time I heard a time station broadcasting the time, I thought &amp;ldquo;wouldn&amp;rsquo;t it be useful if my computer could set its clock off that?&amp;rdquo;
So, I did some digging into it.
ntpd, the network time protocol daemon, has several little-documented features, and it turns out using the audio signal from WWV/H or CHU is one of them, but the code is very old and written for OSS and not ALSA, let alone PulseAudio." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://ke8muj.net/posts/stratum-1-ntp-server-from-wwv/" />




<link rel="stylesheet" href="http://ke8muj.net/assets/style.css">

  <link rel="stylesheet" href="http://ke8muj.net/assets/blue.css">






<link rel="apple-touch-icon" href="http://ke8muj.net/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="http://ke8muj.net/img/favicon/blue.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Stratum 1 NTP Server From WWV/H or CHU">
<meta property="og:description" content="The first time I heard a time station broadcasting the time, I thought &amp;ldquo;wouldn&amp;rsquo;t it be useful if my computer could set its clock off that?&amp;rdquo;
So, I did some digging into it.
ntpd, the network time protocol daemon, has several little-documented features, and it turns out using the audio signal from WWV/H or CHU is one of them, but the code is very old and written for OSS and not ALSA, let alone PulseAudio." />
<meta property="og:url" content="http://ke8muj.net/posts/stratum-1-ntp-server-from-wwv/" />
<meta property="og:site_name" content="KE8MUJ Radio Stuff" />

  
    <meta property="og:image" content="http://ke8muj.net/img/favicon/blue.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-10-30 08:46:10 -0400 EDT" />












</head>
<body class="blue">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    KE8MUJ
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/posts">Posts</a></li>
        
      
        
          <li><a href="/sstv">SSTV Cam</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/posts">Posts</a></li>
      
    
      
        <li><a href="/sstv">SSTV Cam</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="http://ke8muj.net/posts/stratum-1-ntp-server-from-wwv/">Stratum 1 NTP Server From WWV/H or CHU</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-10-30
        
          [Updated: 2021-10-30]
        
      </span>
    
    
    
  </div>

  

  

  

  <div class="post-content"><div>
        <p>The first time I heard a time station broadcasting the time, I thought &ldquo;wouldn&rsquo;t it be useful if my computer could set its clock off that?&rdquo;</p>
<p>So, I did some digging into it.</p>
<p>ntpd, the network time protocol daemon, has several little-documented features, and it turns out using the audio signal from <a href="https://en.wikipedia.org/wiki/WWV_(radio_station)">WWV/H</a> or <a href="https://en.wikipedia.org/wiki/CHU_(radio_station)">CHU</a> is one of them, but the code is very old and written for OSS and not ALSA, let alone PulseAudio.</p>
<p>To set this up, I took my Yaesu FT-891, a SignaLink USB<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, and a Raspberry Pi 3</p>
<p>First tried with Rasbian Linux, and got pretty close with the alsa-oss wrappers, but in the end had no luck. Not sure why, it appeared to be working, but I just never got a clear read on a crystal-clear singal from CHU. YMMV.</p>
<p>Tried again with FreeBSD 13.0 on the pi, and the configuration was pretty much plug and play:</p>
<p><img src="https://mackmyra.static.mojocloud.com/screenshots/eeb45e5b-2392-40a7-b997-8cf8c5ca1382.png" alt="screenshot showing my laptop synced with my Raspberry Pi using CHU as a source"></p>
<p>That&rsquo;s my laptop syncing with my Raspberry Pi @ 192.168.18.189, left that overnight with CHU tuned on 80 meters (3.33 MHz UPPER Sideband) and I&rsquo;m keeping pace with NIST&rsquo;s official servers :)</p>
<p>Configuration is simple, and the documentation is good&hellip; but you do have to <a href="https://github.com/ntp-project/ntp/blob/master-no-authorname/ntpd/refclock_chu.c">read the code</a></p>
<p>/etc/ntp.conf:</p>
<pre><code>server 127.127.7.0
fudge 127.127.7.0 time1 0.14
</code></pre>
<p>14 milliseconds is the time delay I get from CHU. In Detroit, I&rsquo;m about 418 miles from the CHU transmitters in Ottawa in a straight line, which is only about 2ms of radio delay (1ms per 300km - speed of light). My guess is ~12msec is how long it takes the audio signal to be transferred through the soundcard, and processed in the NTP drivers for CHU.</p>
<p>The way I got 14 milliseconds is letting another computer use my Raspberry Pi as a server, along with other known very reliable NTP servers, such as those from NIST and JRC. I picked the number 14 because it looked right, comparing it off the other offsets. Accurate enough for the servers in my basement, no rocket surgery needed :)</p>
<p>Doing this with WWV is just as easy, you&rsquo;d want to use 127.127.36.0 instead of the third octet being 7.</p>
<p>127.127.7.0 = CHU</p>
<p>127.127.36.0 = WWV</p>
<p>&hellip;It&rsquo;s just how ntp.conf works, don&rsquo;t ask me why. The 1990s were a wild time, I guess.</p>
<p>If you have multiple sound cards (FreeBSD didn&rsquo;t automatically detect/load the module for the onboard Pi sound card), you&rsquo;d want to set up a /etc/ntp.audio file, something like this, to use the second sound card:</p>
<pre><code>idev /dev/dsp2
</code></pre>
<p>Both audio drivers (CHU and WWV/H) also support tuning an ICOM radio via the serial port, to switch around to other known signals for CHU or WWV/H if it loses signal on one band. According to the code, the baud rate is set to 9600. I tried symlinking my radio&rsquo;s USB COM port for CAT control to /dev/icom, which looks like it should work&hellip; but when running the program, I don&rsquo;t even see any attempts to access /dev/icom, using strace or truss. Using FreeBSD&rsquo;s ports system to recompile it, there&rsquo;s no option to &ldquo;&ndash;enable-icom&rdquo;, and icom support appears to be hard-enabled from first glance at the code. More digging will be needed here.</p>
<p>Definitely going to poke at this more in any event<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<p>More on this story as it develops</p>
<p>Further reading:</p>
<ul>
<li><a href="https://github.com/ntp-project/ntp/blob/master-no-authorname/ntpd/refclock_chu.c">refclock_chu.c</a></li>
<li><a href="https://github.com/ntp-project/ntp/blob/master-no-authorname/ntpd/refclock_wwv.c">refclock_wwv.c</a></li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>though likely, any modern cheap $10 USB soundcard would work, or probably even the onboard line-in on a normal computer&rsquo;s motherboard&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Fun project ideas, maybe in the future when I get some time: port these drivers to work with an RTL-SDR in direct sampled mode. Then a $20 Raspberry Pi, a $20 RTL-SDR, and a low noise, recieve only Loop-on-Ground antenna could give you a pretty reliable and cheap stratum-1 reference clock. For now this is just a fun toy as I&rsquo;m not going to tie up an expensive HF radio 24x7x365, just to know what time it is, but something like an RTL-SDR would bring this into the realm of practicality.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

      </div></div>

  
  
  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2021 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="http://ke8muj.net/assets/main.js"></script>
<script src="http://ke8muj.net/assets/prism.js"></script>







  
</div>

</body>
</html>
